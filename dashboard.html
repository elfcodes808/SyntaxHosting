<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SyntaxHosting Dashboard</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color:#ddd;}
    body { background:#121212; display:flex; flex-direction:column; min-height:100vh;}
    a { color:#00bfa5; text-decoration:none; transition: color 0.3s;}
    a:hover { color:#26efdb;}
    header { background:#1e1e1e; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333;}
    header h1 { font-weight:700; font-size:1.6rem; color:#00bfa5; letter-spacing:2px;}
    nav { display:flex; align-items:center; gap:1rem;}
    button#logout { background-color:transparent; border:2px solid #00bfa5; color:#00bfa5; padding:0.5rem 1rem; border-radius:6px; font-weight:600; font-size:0.9rem; cursor:pointer; transition:background-color 0.3s,color 0.3s;}
    button#logout:hover { background-color:#00bfa5; color:#121212;}
    main { flex:1; max-width:900px; margin:2rem auto; padding:0 1rem; text-align:center;}
    main h2 { font-size:2.4rem; margin-bottom:1rem; color:#00bfa5;}
    .create-server-btn { display:inline-block; background-color:#00bfa5; color:#121212; padding:1rem 2rem; border-radius:8px; font-weight:700; font-size:1.2rem; cursor:pointer; transition: background-color 0.3s ease; margin-top:3rem; text-decoration:none;}
    .create-server-btn:hover { background-color:#26efdb; color:#121212;}
    #server-list { margin-top:2rem; text-align:left;}
    #server-list h3 { color:#26efdb; margin-bottom:0.5rem;}
    #servers li { cursor:pointer; padding:0.5rem; border:1px solid #00bfa5; border-radius:6px; margin-bottom:0.5rem; transition:all 0.2s ease;}
    #servers li:hover { background-color:#26efdb; color:#121212;}
  </style>
</head>
<body>

<header>
  <h1>SyntaxHosting Dashboard</h1>
  <nav>
    <button id="logout">Logout</button>
  </nav>
</header>

<main>
  <h2 id="welcome-title">Welcome back!</h2>

  <section id="server-list">
    <h3>Your Servers</h3>
    <ul id="servers"></ul>
  </section>

  <a href="#" class="create-server-btn" id="createServerBtn">Create Server</a>
</main>

<script>
  // Grab session ID from URL if exists
  const urlParams = new URLSearchParams(window.location.search);
  const urlSession = urlParams.get('session');
  const storedSession = urlSession || localStorage.getItem('sessionId');

  if (!storedSession) {
    alert('Not authenticated. Please log in again.');
    window.location.href = '/';
  } else {
    localStorage.setItem('sessionId', storedSession);
  }

  const serversList = document.getElementById('servers');

  // Logout
  document.getElementById('logout').addEventListener('click', () => {
    localStorage.clear();
    window.location.href = '/index.html';
  });

  let discordUsername = localStorage.getItem('discordUsername');

  // Fetch user info if username not stored
  async function fetchUser() {
    try {
      if (!discordUsername) {
        const res = await fetch('https://syntaxguard-backend.onrender.com/api/me', {
          headers: { 'x-session-id': storedSession }
        });
        const data = await res.json();
        discordUsername = data.username;
        localStorage.setItem('discordUsername', discordUsername);
      }
      document.getElementById('welcome-title').textContent = `Welcome back, ${discordUsername}!`;
    } catch (err) {
      console.error('Failed to fetch user info:', err);
      alert('Authentication failed. Please log in again.');
      localStorage.clear();
      window.location.href = '/';
    }
  }

  // Fetch servers
  async function fetchServers() {
    try {
      const res = await fetch('https://syntaxguard-backend.onrender.com/api/servers', {
        headers: { 'x-session-id': storedSession }
      });
      const data = await res.json();
      serversList.innerHTML = '';

      if (data.servers && data.servers.length > 0) {
        data.servers.forEach(server => {
          const li = document.createElement('li');
          li.textContent = server.name;
          li.addEventListener('click', () => openBuilder(server));
          serversList.appendChild(li);
        });
      } else {
        serversList.innerHTML = '<li>No servers yet. Create one!</li>';
      }
    } catch (err) {
      console.error('Failed to fetch servers:', err);
      serversList.innerHTML = '<li>Failed to load servers.</li>';
    }
  }

  // Create server
  document.getElementById('createServerBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const serverName = prompt('Enter a name for your server:');
    if (!serverName) return;

    try {
      const response = await fetch('https://syntaxguard-backend.onrender.com/api/create-server', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-session-id': storedSession
        },
        body: JSON.stringify({ name: serverName })
      });

      const data = await response.json();
      if (data.success) {
        alert(`✅ Server "${data.server.name}" created successfully!`);
        fetchServers();
      } else {
        alert(`❌ Error: ${data.error || 'Unknown error'}`);
      }
    } catch (err) {
      alert('Failed to create server. See console.');
      console.error(err);
    }
  });

  // Builder simulation
  function openBuilder(server) {
    alert(`🚧 Building server "${server.name}"... This may take 10-20 seconds.`);
    setTimeout(() => {
      alert(`✅ Server "${server.name}" is ready! Open Console, Files, Settings, Logs, Status tabs now.`);
    }, 10000);
  }

  // Initialize dashboard
  fetchUser();
  fetchServers();
</script>

</body>
</html>
